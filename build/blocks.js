(()=>{"use strict";const e=window.wp.element,t=window.wp.i18n,{registerPaymentMethod:a}=wc.wcBlocksRegistry,{getSetting:n}=wc.wcSettings,r="https://www.vismapay.com",s=n("vismapay_embedded_card_data",{}),c={generic:`${(0,t.__)("Something went wrong","visma-pay-embedded-card-payment-gateway")}.`,formInvalid:`${(0,t.__)("Please check the card information","visma-pay-embedded-card-payment-gateway")}.`},i=()=>(0,e.createElement)("div",{id:"pf-cc-form"},(0,e.createElement)("iframe",{scrolling:"no",id:"pf-cc-iframe",className:"intrinsic-ignore",height:"220px",style:{border:"none",width:"100%"},src:`${r}/e-payments/embedded_card_form?lang=${s.lang}`})),m=()=>(s.visa||s.master||s.amex||s.diners)&&(0,e.createElement)("div",{className:"vpe-card-brand-row"},s.visa&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)(o,{imgSrc:"visa.png",imgAlt:"Visa",imgClassNames:"visa"}),(0,e.createElement)(o,{imgSrc:"verified.png",imgAlt:"Verified by Visa",imgClassNames:"verified"})),s.mastercard&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)(o,{imgSrc:"mastercard.png",imgAlt:"MasterCard"}),(0,e.createElement)(o,{imgSrc:"securecode.png",imgAlt:"MasterCard SecureCode"})),s.amex&&(0,e.createElement)(o,{imgSrc:"americanexpress.png",imgAlt:"America Express"}),s.diners&&(0,e.createElement)(o,{imgSrc:"dinersclub.png",imgAlt:"Diners"}),(0,e.createElement)("div",{style:{display:"block",clear:"both"}})),l=()=>s.onlyAuthorize&&(0,e.createElement)("div",{className:"woocommerce-info"},(0,t.sprintf)((0,t.__)("An authorization of 1 %s will be made on your card to save your card details. The authorization will be automatically cancelled after the order has been accepted.","visma-pay-embedded-card-payment-gateway"),s.currency)),o=({imgSrc:t,imgAlt:a,imgClassNames:n=""})=>(0,e.createElement)("div",{className:"vpe-card-brand-container"},(0,e.createElement)("img",{className:`vpe-card-brand-logo ${n}`,src:`${s.imgUrl}/${t}`,alt:a})),d=({eventRegistration:a,emitResponse:n,components:s})=>{const{onCheckoutValidation:o,onPaymentSetup:d,onCheckoutSuccess:p,onCheckoutFail:g}=a,{responseTypes:u}=n,{LoadingMask:y}=s,[f,E]=(0,e.useState)(!1);let v=null;const w=e=>{if(e.origin!==r)return;let t=null;try{t=JSON.parse(e.data)}catch(e){}v=null!==t&&void 0!==t.valid&&!0===t.valid},S=async(e=3e3)=>{let t=!0,a=!1;for(setTimeout((()=>{null===v&&(t=!1)}),e);t&&!a;)if(null!==v)a=!0;else{const e=new Promise((e=>{setTimeout(e,100)}));await e}if(null===v)return Promise.reject()};(0,e.useEffect)((()=>(window.addEventListener("message",w),()=>{window.removeEventListener("message",w)})),[]),(0,e.useEffect)((()=>{const e=o((async()=>{E(!0);const e=document.querySelector("#pf-cc-iframe");if(!e)return E(!1),{errorMessage:c.generic};e.contentWindow.postMessage(JSON.stringify({action:"validate"}),r);try{await S()}catch(e){return E(!1),{errorMessage:c.generic}}return!!v||(E(!1),{errorMessage:c.formInvalid})}));return()=>{e()}}),[o]),(0,e.useEffect)((()=>{const e=d((()=>({type:u.SUCCESS,meta:{paymentMethodData:{payment_method:"visma_pay_embedded_card"}}})));return()=>{e()}}),[u.SUCCESS,d]),(0,e.useEffect)((()=>{const e=p((async e=>{const t=e?.processingResponse;if(t&&"success"===t?.paymentStatus&&"success"===t?.paymentDetails?.result&&t.paymentDetails.bpf_token){const e=document.querySelector("#pf-cc-iframe");if(!e)return E(!1),{type:u.ERROR,message:c.generic};const a={action:"pay",token:t.paymentDetails.bpf_token};e.contentWindow.postMessage(JSON.stringify(a),r);try{await S(5e3)}catch(e){return E(!1),{type:u.ERROR,message:c.generic}}return!!v||(E(!1),{type:u.ERROR,message:c.formInvalid})}return E(!1),{type:u.ERROR,message:c.generic}}));return()=>{e()}}),[u.ERROR,u.SUCCESS,p]),(0,e.useEffect)((()=>{const e=g((e=>(E(!1),!0)));return()=>{e()}}),[g]);const b=(0,e.createElement)("div",{id:"visma-pay-embedded-card-payment-content"},(0,e.createElement)("p",null,(0,t.__)("Payment card","visma-pay-embedded-card-payment-gateway")),(0,e.createElement)(l,null),(0,e.createElement)(i,null),(0,e.createElement)(m,null));return(0,e.createElement)(y,{isLoading:f,showSpinner:!0},b)};a({name:"visma_pay_embedded_card",label:(0,e.createElement)((t=>{const{PaymentMethodLabel:a}=t.components;return(0,e.createElement)(a,{text:s.title})}),null),ariaLabel:s.title,content:(0,e.createElement)(d,null),edit:(0,e.createElement)(d,null),canMakePayment:()=>!0,paymentMethodId:"visma_pay_embedded_card",supports:{features:s.supports}})})();